name: Create Infrastructure

on:
  workflow_call:
    outputs:
      eks_cluster_name: 
        value: ${{ jobs.create-infra.outputs.eks_cluster_name}}
      ecr_repo_name:
        value: ${{ jobs.create-infra.outputs.ecr_repo_name }}

jobs:
  create-infra:
    runs-on: ubuntu-latest
    
    outputs:
      eks_cluster_name: ${{ steps.terraform-outputs.outputs.eks_cluster_name }}
      ecr_repo_name: ${{ steps.terraform-outputs.outputs.ecr_repo_name }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: us-east-1
        role-to-assume: ${{ secrets.AWS_OIDC_ROLE }}
    
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
    
    - name: Terraform Init
      working-directory: ./iac
      run: terraform init
    
    - name: Terraform Apply
      working-directory: ./iac
      run: |
        terraform apply -auto-approve \
          -var="github_actions_role_arn=${{ secrets.AWS_OIDC_ROLE }}"
    
    - name: Get Terraform Outputs
      working-directory: ./iac
      id: terraform-outputs
      run: |
        echo "eks_cluster_name=$(terraform output -raw eks_cluster_name)" >> $GITHUB_OUTPUT
        echo "ecr_repo_name=$(terraform output -raw ecr_repo_name)" >> $GITHUB_OUTPUT
